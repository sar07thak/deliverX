@model DeliveryDost.Application.DTOs.Dashboard.StakeholderDetailDto
@{ ViewData["Title"] = $"Stakeholder - {Model.FullName}"; }

<div class="page-header">
    <div class="d-flex justify-content-between align-items-center">
        <div>
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb mb-1">
                    <li class="breadcrumb-item"><a asp-action="StakeholderOnboarding">Onboarding</a></li>
                    <li class="breadcrumb-item"><a asp-action="Stakeholders">Stakeholders</a></li>
                    <li class="breadcrumb-item active">@Model.FullName</li>
                </ol>
            </nav>
            <h1 class="page-title">@Model.FullName</h1>
            <p class="page-subtitle">@Model.Phone | @Model.Role</p>
        </div>
        <div>
            <a asp-action="Stakeholders" class="btn btn-outline-secondary">
                <i class="bi bi-arrow-left me-1"></i>Back to List
            </a>
        </div>
    </div>
</div>

<!-- Status Cards -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card">
            <div class="card-body text-center">
                <h6 class="text-muted mb-2">Status</h6>
                @if (Model.Status == "Active")
                {
                    <span class="badge bg-success fs-6">Active</span>
                }
                else
                {
                    <span class="badge bg-danger fs-6">Inactive</span>
                }
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card">
            <div class="card-body text-center">
                <h6 class="text-muted mb-2">KYC Status</h6>
                @if (Model.KYCStatus == "VERIFIED")
                {
                    <span class="badge bg-success fs-6"><i class="bi bi-check-circle me-1"></i>Verified</span>
                }
                else
                {
                    <span class="badge bg-warning text-dark fs-6"><i class="bi bi-clock me-1"></i>Pending</span>
                }
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card">
            <div class="card-body text-center">
                <h6 class="text-muted mb-2">Wallet Balance</h6>
                <h4 class="mb-0 text-success">₹@Model.WalletBalance.ToString("N0")</h4>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card">
            <div class="card-body text-center">
                <h6 class="text-muted mb-2">Total Deliveries</h6>
                <h4 class="mb-0">@Model.TotalDeliveries</h4>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <!-- Basic Information -->
    <div class="col-md-6">
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-person me-2"></i>Basic Information</h5>
            </div>
            <div class="card-body">
                <table class="table table-sm table-borderless">
                    <tr>
                        <td class="text-muted" style="width: 40%;">Full Name</td>
                        <td><strong>@Model.FullName</strong></td>
                    </tr>
                    <tr>
                        <td class="text-muted">Phone</td>
                        <td>@Model.Phone</td>
                    </tr>
                    <tr>
                        <td class="text-muted">Email</td>
                        <td>@(Model.Email ?? "Not provided")</td>
                    </tr>
                    <tr>
                        <td class="text-muted">Role</td>
                        <td>
                            <span class="badge @GetRoleBadgeClass(Model.Role)">
                                @(Model.Role switch
                                {
                                    "DPCM" => "Delivery Channel Partner Manager",
                                    "DP" => "Delivery Partner",
                                    "BC" => "Business Consumer",
                                    "DBC" => "Digital Business Consumer",
                                    "EC" => "End Consumer",
                                    _ => Model.Role
                                })
                            </span>
                        </td>
                    </tr>
                    <tr>
                        <td class="text-muted">Joined</td>
                        <td>@Model.CreatedAt.ToString("dd MMM yyyy, hh:mm tt")</td>
                    </tr>
                    @if (Model.LastLoginAt.HasValue)
                    {
                        <tr>
                            <td class="text-muted">Last Login</td>
                            <td>@Model.LastLoginAt.Value.ToString("dd MMM yyyy, hh:mm tt")</td>
                        </tr>
                    }
                </table>
            </div>
        </div>

        <!-- Address -->
        @if (!string.IsNullOrEmpty(Model.Address) || !string.IsNullOrEmpty(Model.City))
        {
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0"><i class="bi bi-geo-alt me-2"></i>Address</h5>
                </div>
                <div class="card-body">
                    <p class="mb-0">
                        @Model.Address<br />
                        @Model.City, @Model.State - @Model.Pincode
                    </p>
                </div>
            </div>
        }
    </div>

    <!-- Role Specific Details -->
    <div class="col-md-6">
        <!-- KYC Information -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-shield-check me-2"></i>KYC Information</h5>
            </div>
            <div class="card-body">
                <table class="table table-sm table-borderless">
                    <tr>
                        <td class="text-muted" style="width: 40%;">Aadhaar</td>
                        <td>
                            @if (Model.AadhaarVerified)
                            {
                                <span class="badge bg-success"><i class="bi bi-check-circle me-1"></i>Verified</span>
                                <small class="ms-2 text-muted">@Model.AadhaarMasked</small>
                            }
                            else
                            {
                                <span class="badge bg-secondary">Not Verified</span>
                            }
                        </td>
                    </tr>
                    <tr>
                        <td class="text-muted">PAN</td>
                        <td>
                            @if (Model.PANVerified)
                            {
                                <span class="badge bg-success"><i class="bi bi-check-circle me-1"></i>Verified</span>
                                <small class="ms-2 text-muted">@Model.PANMasked</small>
                            }
                            else
                            {
                                <span class="badge bg-secondary">Not Verified</span>
                            }
                        </td>
                    </tr>
                    @if (Model.KYCVerifiedAt.HasValue)
                    {
                        <tr>
                            <td class="text-muted">Verified On</td>
                            <td>@Model.KYCVerifiedAt.Value.ToString("dd MMM yyyy")</td>
                        </tr>
                    }
                </table>
            </div>
        </div>

        <!-- DPCM Details -->
        @if (Model.DPCMDetails != null)
        {
            <div class="card mb-4">
                <div class="card-header bg-purple text-white">
                    <h5 class="mb-0"><i class="bi bi-person-badge me-2"></i>DPCM Details</h5>
                </div>
                <div class="card-body">
                    <table class="table table-sm table-borderless">
                        @if (!string.IsNullOrEmpty(Model.DPCMDetails.BusinessName))
                        {
                            <tr>
                                <td class="text-muted" style="width: 40%;">Business Name</td>
                                <td><strong>@Model.DPCMDetails.BusinessName</strong></td>
                            </tr>
                        }
                        <tr>
                            <td class="text-muted">Commission</td>
                            <td>
                                @Model.DPCMDetails.CommissionValue
                                @(Model.DPCMDetails.CommissionType == "PERCENTAGE" ? "%" : " Fixed")
                            </td>
                        </tr>
                        <tr>
                            <td class="text-muted">Security Deposit</td>
                            <td>₹@Model.DPCMDetails.SecurityDeposit.ToString("N0")</td>
                        </tr>
                        <tr>
                            <td class="text-muted">Managed DPs</td>
                            <td>
                                <strong>@Model.DPCMDetails.ManagedDPsCount</strong> total,
                                <span class="text-success">@Model.DPCMDetails.ActiveDPsCount active</span>
                            </td>
                        </tr>
                        @if (Model.DPCMDetails.ServiceRegions.Any())
                        {
                            <tr>
                                <td class="text-muted">Service Regions</td>
                                <td>
                                    @foreach (var region in Model.DPCMDetails.ServiceRegions)
                                    {
                                        <span class="badge bg-light text-dark me-1">@region</span>
                                    }
                                </td>
                            </tr>
                        }
                    </table>
                </div>
            </div>
        }

        <!-- DP Details -->
        @if (Model.DPDetails != null)
        {
            <div class="card mb-4">
                <div class="card-header bg-warning text-dark">
                    <h5 class="mb-0"><i class="bi bi-bicycle me-2"></i>Delivery Partner Details</h5>
                </div>
                <div class="card-body">
                    <table class="table table-sm table-borderless">
                        <tr>
                            <td class="text-muted" style="width: 40%;">Online Status</td>
                            <td>
                                @if (Model.DPDetails.IsOnline)
                                {
                                    <span class="badge bg-success"><i class="bi bi-circle-fill me-1"></i>Online</span>
                                }
                                else
                                {
                                    <span class="badge bg-secondary"><i class="bi bi-circle me-1"></i>Offline</span>
                                }
                            </td>
                        </tr>
                        <tr>
                            <td class="text-muted">Vehicle</td>
                            <td>
                                @Model.DPDetails.VehicleType
                                @if (!string.IsNullOrEmpty(Model.DPDetails.VehicleNumber))
                                {
                                    <small class="text-muted ms-2">(@Model.DPDetails.VehicleNumber)</small>
                                }
                            </td>
                        </tr>
                        @if (!string.IsNullOrEmpty(Model.DPDetails.DPCMName))
                        {
                            <tr>
                                <td class="text-muted">Manager (DPCM)</td>
                                <td><strong>@Model.DPDetails.DPCMName</strong></td>
                            </tr>
                        }
                        <tr>
                            <td class="text-muted">Behavior Index</td>
                            <td>
                                <div class="progress" style="height: 20px;">
                                    <div class="progress-bar @GetBehaviorBarClass(Model.DPDetails.BehaviorIndex)"
                                         style="width: @Model.DPDetails.BehaviorIndex%">
                                        @Model.DPDetails.BehaviorIndex%
                                    </div>
                                </div>
                            </td>
                        </tr>
                        @if (Model.DPDetails.ServicePincodes.Any())
                        {
                            <tr>
                                <td class="text-muted">Service Pincodes</td>
                                <td>
                                    @foreach (var pincode in Model.DPDetails.ServicePincodes.Take(5))
                                    {
                                        <span class="badge bg-light text-dark me-1">@pincode</span>
                                    }
                                    @if (Model.DPDetails.ServicePincodes.Count > 5)
                                    {
                                        <span class="text-muted">+@(Model.DPDetails.ServicePincodes.Count - 5) more</span>
                                    }
                                </td>
                            </tr>
                        }
                    </table>
                </div>
            </div>
        }

        <!-- BC Details -->
        @if (Model.BCDetails != null)
        {
            <div class="card mb-4">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0"><i class="bi bi-building me-2"></i>Business Details</h5>
                </div>
                <div class="card-body">
                    <table class="table table-sm table-borderless">
                        @if (!string.IsNullOrEmpty(Model.BCDetails.BusinessName))
                        {
                            <tr>
                                <td class="text-muted" style="width: 40%;">Business Name</td>
                                <td><strong>@Model.BCDetails.BusinessName</strong></td>
                            </tr>
                        }
                        @if (!string.IsNullOrEmpty(Model.BCDetails.BusinessType))
                        {
                            <tr>
                                <td class="text-muted">Business Type</td>
                                <td>@Model.BCDetails.BusinessType</td>
                            </tr>
                        }
                        @if (!string.IsNullOrEmpty(Model.BCDetails.GSTIN))
                        {
                            <tr>
                                <td class="text-muted">GSTIN</td>
                                <td>@Model.BCDetails.GSTIN</td>
                            </tr>
                        }
                        <tr>
                            <td class="text-muted">API Access</td>
                            <td>
                                @if (Model.BCDetails.HasAPIAccess)
                                {
                                    <span class="badge bg-success"><i class="bi bi-check-circle me-1"></i>Enabled</span>
                                    <small class="text-muted ms-2">@Model.BCDetails.APIKeyCount keys</small>
                                }
                                else
                                {
                                    <span class="badge bg-secondary">Not Enabled</span>
                                }
                            </td>
                        </tr>
                    </table>
                </div>
            </div>
        }
    </div>
</div>

<!-- Activity Stats -->
<div class="card">
    <div class="card-header">
        <h5 class="mb-0"><i class="bi bi-graph-up me-2"></i>Activity Summary</h5>
    </div>
    <div class="card-body">
        <div class="row text-center">
            <div class="col-md-3">
                <h3 class="mb-0">@Model.TotalDeliveries</h3>
                <small class="text-muted">Total Deliveries</small>
            </div>
            <div class="col-md-3">
                <h3 class="mb-0 text-success">@Model.CompletedDeliveries</h3>
                <small class="text-muted">Completed</small>
            </div>
            <div class="col-md-3">
                <h3 class="mb-0 text-danger">@Model.CancelledDeliveries</h3>
                <small class="text-muted">Cancelled</small>
            </div>
            <div class="col-md-3">
                @if (Model.Rating.HasValue)
                {
                    <h3 class="mb-0">
                        @Model.Rating.Value.ToString("N1")
                        <i class="bi bi-star-fill text-warning"></i>
                    </h3>
                    <small class="text-muted">@Model.RatingCount ratings</small>
                }
                else
                {
                    <h3 class="mb-0 text-muted">-</h3>
                    <small class="text-muted">No ratings</small>
                }
            </div>
        </div>
    </div>
</div>

@functions {
    string GetRoleBadgeClass(string role) => role switch
    {
        "Admin" => "bg-danger",
        "DPCM" => "bg-purple",
        "DP" => "bg-warning text-dark",
        "BC" or "DBC" => "bg-info",
        "EC" => "bg-success",
        _ => "bg-secondary"
    };

    string GetBehaviorBarClass(decimal index) => index switch
    {
        >= 80 => "bg-success",
        >= 60 => "bg-info",
        >= 40 => "bg-warning",
        _ => "bg-danger"
    };
}

@section Styles {
    <style>
        .bg-purple { background-color: #6f42c1 !important; color: white; }
        .page-header { margin-bottom: 1.5rem; }
        .page-title { font-size: 1.75rem; font-weight: 600; margin-bottom: 0.25rem; }
        .page-subtitle { color: #6c757d; margin-bottom: 0; }
    </style>
}
